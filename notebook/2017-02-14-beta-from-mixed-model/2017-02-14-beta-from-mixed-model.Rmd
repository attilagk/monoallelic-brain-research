## Motivation

For certain genes $g$ allelic bias was found to depend on biological predictors (Age, Dx, Ancestry) in our previous analysis.  That analysis fitted various **fixed effects** multiple regression models (GLM family) using as response variable the read count ratio $S_{ig}$ or its quasi-log transformed version $Q_{ig}$.  After checking model fit, we primarily based our results to a weighted, normal linear model using $Q_{ig}$, which we called *wnlm.Q* (as opposed to its unweighted variation *unlm.Q*).  Significant dependence of the allelic bias of gene $g$ on (some level of) the predictor $p$ was assessed in terms of the estimated regression coefficient $\hat{\beta}_{pg}$.

But decomposition of variance using `variancePartition` showed that a predictor that significantly affected allelic bias for a certain gene did not necessarily explain substantial fraction of variance.  This was the case in spite of using the same response and predictors in the **mixed effects** model for `variancePartition` as for fixed effects models like wnlm.Q.

What is the reason for this discrepancy?

1. $\hat{\beta}_{pg}$ under the fixed effects model largely deviates from that under the mixed effects model because of
    * differences between the two model frameworks
    * programming bug
1. $\hat{\beta}_{pg}$ under the fixed effects agrees with that under the mixed effects model
    * in this case the discrepancy arises from the somewhat different questions that the two analyses address

The analysis below appears to support the second case rather than the first.

## Calculations

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(variancePartition)
library(doParallel)
library(lattice)
lattice.options(default.args = list(as.table = TRUE))
lattice.options(default.theme = "standard.theme")
opts_chunk$set(dpi = 144)
opts_chunk$set(out.width = "700px")
opts_chunk$set(dev = c("png", "pdf"))
source("../../src/import-data.R")
source("~/projects/monoallelic-brain/src/fit-glms.R")
```

Import data

```{r}
# selected set of genes
gene.ids <- unlist(read.csv("../../data/genes.regression.new", as.is = TRUE))
names(gene.ids) <- gene.ids
# predictors
names(e.vars) <- e.vars
E <- get.predictors()[e.vars]
# response: Q, quasi-log transformed read count ratio
Y <- get.readcounts(gene.ids = gene.ids, count.thrs = 0)
Q <- data.frame(sapply(Y[gene.ids], getElement, "Q"), check.names = FALSE)
# response: S, untransformed
S <- data.frame(sapply(Y[gene.ids], getElement, "S"), check.names = FALSE)
```

Fit various fixed effect models to data for `r length(gene.ids)` selected genes

```{r, warning=FALSE, cache=TRUE}
M <- do.all.fits(Z = Y[gene.ids], G = E)
```

Define model formula for fitting using the  `fitVarPartModel`

```{r, warning=FALSE}
(fchar <- as.character(formula(M$unlm.Q$MEST)))
fm <- list()
fm$fixed <- as.formula(paste(fchar[1], fchar[3]))
fm$mixed.1 <- ~ Age + (1|Institution) + (1|Gender) + PMI + (1|Dx) + RIN +(1|RNA_batch) + Ancestry.1 + Ancestry.2 + Ancestry.3 + Ancestry.4 + Ancestry.5
fm$mixed.2 <- ~ Age + (1|Institution) + Gender + PMI + Dx + RIN +(1|RNA_batch) + Ancestry.1 + Ancestry.2 + Ancestry.3 + Ancestry.4 + Ancestry.5
```

Fit fixed and mixed effects models using `variancePartition` 

```{r, warning=FALSE, cache=TRUE}
M$unlm.Q.varPart <- fitVarPartModel(t(Q), fm$fixed, E)
M$mixed.1 <- fitVarPartModel(t(Q), fm$mixed.1, E)
#M$mixed.2 <- fitVarPartModel(t(Q), fm$mixed.2, E)
```

Extract $\hat{\beta}_{pg}$ for each gene $g$ under each model:

```{r}
coef.names <- names(coef(M$unlm.Q[[1]]))
cf <- data.frame(lapply(M[- length(M)],
                        function(l.m)
                            stack(lapply(l.m,
                                         function(m)
                                             coef(m)[ coef.names ]))$values))
cf$mixed.1 <-
    stack(lapply(M$mixed.1,
                 function(m)
                     unlist(coef(m)[[1]][1, , drop = TRUE])[ coef.names ]))$values
#cf$coefficient <- rep(coef.names, length(gene.ids))
cf$coefficient <- factor(rep(coef.names, length(gene.ids)), ordered = TRUE, levels = coef.names)
cf$gene <- factor(rep(gene.ids, each = length(coef.names)), ordered = TRUE, levels = gene.ids)
```

## Results: estimated coefficients

To test various implementations of the same fixed effects model:

```{r fixed-fixed, echo=FALSE}
# annotation keys
my.key <-
    list(coefficient =
             list(columns = 5, text = list(paste0("(", seq_along(levels(cf$coefficient)), ") ", levels(cf$coefficient)), cex = 0.7)),
         gene =
             list(columns = 5, text = list(paste0("(", seq_along(levels(cf$gene)), ") ", levels(cf$gene)), cex = 0.7)))

# high level plotting function
my.plot <- function(fm = formula(unlm.Q.varPart ~ unlm.Q | gene), lbl.type = "coefficient", ...) {
    my.panel <- function(..., lbl) {
        panel.abline(a = 0, b = 1, lty = "dotted", col = "gray")
        lbl <-
            if(lbl.type == "coefficient") cf$coefficient
            else cf$gene
        panel.text(..., pch = lbl, cex = 0.7)
    }
    xyplot(fm, data = cf, panel = my.panel,
           scales = list(relation = ifelse(lbl.type == "coefficient", "same", "free")),
           key = my.key[[lbl.type]], ...)
}
my.lim = c(-5, 5)
my.main <- "Fixed effects w/o variancePartition"
lbl.type <- "coefficient"
my.plot(fm = formula(unlm.Q.varPart ~ unlm.Q | gene), lbl.type = "coefficient", main = my.main, xlim = my.lim, ylim = my.lim)
lbl.type <- "gene"
my.plot(fm = formula(unlm.Q.varPart ~ unlm.Q | coefficient), lbl.type = "gene", main = my.main)
```

Consistent with the above graphs, the coefficients from one implementation are precisely equal to those from the other implementation:

```{r}
with(cf, all.equal(unlm.Q, unlm.Q.varPart))
```

Compare the mixed effects model to the fixed effects model unml.Q; note that both are unweighted

```{r mixed-1-fixed, echo=FALSE}
my.main <- "Mixed vs fixed effects"
lbl.type <- "coefficient"
my.plot(fm = formula(mixed.1 ~ unlm.Q | gene), lbl.type = "coefficient", main = my.main, xlim = my.lim, ylim = my.lim)
lbl.type <- "gene"
my.plot(fm = formula(mixed.1 ~ unlm.Q | coefficient), lbl.type = "gene", main = my.main)
```

Compare the *unweighted* mixed effects model to *weighted* the fixed effects model wnml.Q

```{r mixed-1-fixed-weighted, echo=FALSE}
my.main <- "Unweighted mixed vs weighted fixed effects"
lbl.type <- "coefficient"
my.plot(fm = formula(mixed.1 ~ wnlm.Q | gene), lbl.type = "coefficient", main = my.main, xlim = my.lim, ylim = my.lim)
lbl.type <- "gene"
my.plot(fm = formula(mixed.1 ~ wnlm.Q | coefficient), lbl.type = "gene", main = my.main)
```
