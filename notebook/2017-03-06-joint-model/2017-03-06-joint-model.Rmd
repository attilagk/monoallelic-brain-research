---
layout: default
tags: [regression, anova ]
---

An ad-hoc forward model selection strategy is used to evaluate the effect of the terms of the linear predictor in mixed effects models.  A strongly reduced starting model is prompted by earlier analysis using linear models conditioned on genes.  The model space is explored using that prior knowledge combined with information criteria (BIC and AIC) and likelihood ratio test.  The biologically interesting finding is that Ancestry and Age have significant effect but only when their interaction with genes is considered.  Their marginal effect (without that interaction) is very weak.

```{r echo=FALSE}
library(lme4)
library(lattice)
#library(latticeExtra)
opts_chunk$set(dpi = 144)
opts_chunk$set(out.width = "700px")
opts_chunk$set(dev = c("png", "pdf"))
lattice.options(default.args = list(as.table = TRUE))
lattice.options(default.theme = "standard.theme")
source("../../src/import-data.R")
source("../../src/fit-glms.R")
source("2017-03-06-joint-model.R")
```

Selected genes (inferred to be imprinted)

```{r}
gene.ids <- unlist(read.csv("../../data/genes.regression.new", as.is = TRUE))
names(gene.ids) <- gene.ids
```

Prepare data frame including all `r length(gene.ids)` selected genes

```{r cache=FALSE}
dat <- merge.data(gene.ids = gene.ids)
```

## Model selection

The strategy is to start from a model $$M1$$ that includes the strongest predictor terms based on previous analysis using separately modeling genes, then confirm the significant effect of these terms.  After this, single---mainly technical---terms are added separately (not yet accumulatively) to $$M1$$ to asses the effect of these.  The terms that improve the fit according to some criterion will be jointly added to $$M1$$ resulting in $$M2$$.  A similar procedure involving two sets of biological terms takes model selection further resulting in $$M3$$ and $$M4$$.

### Starting with model $$M1$$

```{r cache=FALSE}
fo <- Q ~ scale(RIN) + (1 | RNA_batch) + (1 | Institution) + (1 | Institution:Individual) + (scale(Age) | Gene)
(M1 <- lmer(fo, data = dat))
```

```{r cache=TRUE, message=FALSE, warning=TRUE, echo=TRUE}
av <- list()
av$RIN <- anova(update(M1, . ~ . - scale(RIN)), M1)
av$RNA_batch <- anova(update(M1, . ~ . - (1 | RNA_batch)), M1)
av$Institution <- anova(update(M1, . ~ . - (1 | Institution)), M1)
av$Individual <- anova(update(M1, . ~ . - (1 | Institution:Individual)), M1)
av$Age.Gene <- anova(update(M1, . ~ . - (scale(Age) | Gene) + (1 | Gene)), M1)
av$Gene <- anova(update(M1, . ~ . - (scale(Age) | Gene)), update(M1, . ~ . - (scale(Age) | Gene) + (1 | Gene)))
```

```{r}
summarize.anova <- function(av)
    do.call(rbind, lapply(av, function(x)
                          data.frame(Delta.AIC = diff(x$AIC),
                                     Delta.BIC = diff(x$BIC),
                                     Chisq = x$Chisq[2],
                                     df = x[["Chi Df"]][2],
                                     p.Chi = x[["Pr(>Chisq)"]][2])))
print.av(summarize.anova(av))
```

#### Notable results

* every term improves model fit by all three criteria (AIC, BIC, $$\chi^2$$ test)
* in particular, *Age* conditioned on *Gene* leads to the 3rd largest improvement (behind *Gene* and *Individual*)
    * however, this result needs to be confirmed in the context of a more general model 

### Extending $$M1$$ to $$M2$$ with technical terms

```{r cache=TRUE, message=FALSE, warning=TRUE, echo=TRUE}
av.1 <- list()
# interactions between random-effect factors
av.1$Gene.Instit <- anova(M1, update(M1, . ~ . + (1 | Gene:Institution)))
av.1$Gene.RNA_batch <- anova(M1, update(M1, . ~ . + (1 | Gene:RNA_batch)))
av.1$RNA_batch.Instit <- anova(M1, update(M1, . ~ . + (1 | RNA_batch:Institution)))
# interactions between random-effect covariates and factors
# RIN
av.1$RIN.Instit <- anova(M1, update(M1, . ~ . - (1 | Institution) + (scale(RIN) | Institution)))
av.1$RIN.RNA_batch <- anova(M1, update(M1, . ~ . - (1 | RNA_batch) + (scale(RIN) | RNA_batch)))
av.1$RIN.Gene <- anova(M1, update(M1, . ~ . - (1 | Gene) + (scale(RIN) | Gene)))
# PMI
av.1$PMI.Instit <- anova(M1, update(M1, . ~ . - (1 | Institution) + (scale(PMI) | Institution)))
av.1$PMI.RNA_batch <- anova(M1, update(M1, . ~ . - (1 | RNA_batch) + (scale(PMI) | RNA_batch)))
av.1$PMI.Gene <- anova(M1, update(M1, . ~ . - (1 | Gene) + (scale(PMI) | Gene)))
av.1$PMI <- anova(M1, update(M1, . ~ . + scale(PMI)))
# Age revisited
av.1$Age.Instit <- anova(M1, update(M1, . ~ . - (1 | Institution) + (scale(Age) | Institution)))
av.1$Age.RNA_batch <- anova(M1, update(M1, . ~ . - (1 | RNA_batch) + (scale(Age) | RNA_batch)))
av.1$Age <- anova(M1, update(M1, . ~ . + scale(Age)))
```

```{r}
print.av(summarize.anova(av.1))
```

#### Notable results

* interaction of *Gene* with certain other predictors leads to large improvement in fit
    * this is not surprising since *Gene* has by far the largest impact among other main effects (see above)
    * but the fact that the improvement is due to accounting for interaction between a biological predictor (*Age*) and some technical predictor (*RIN*, *Insitution*, or *PMI*) is difficult to explain mechanistically
* *Age* shows essentially no interaction with *Institution* or *RNA_batch*
    * this is expected: the effect of *Age* should not depend on e.g. the *Institution*; so the result shows the advantage of joint modeling because previous results with separate, gene-based, modeling suggested strong interaction between *Age* and *Institution*

### Extending $$M2$$ with biological terms

```{r cache=TRUE}
M1b <- update(M1, . ~ . + (1 | Gene:Institution) - (scale(Age) | Gene))
(M2 <- update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(PMI) | Gene)))
```

```{r cache=TRUE, message=FALSE, warning=TRUE, echo=TRUE}
av.2 <- list()
# Ancestry
av.2$Ances1 <- anova(M2, update(M2, . ~ . + scale(Ancestry.1)))
av.2$Ances2 <- anova(M2, update(M2, . ~ . + scale(Ancestry.2)))
av.2$Ances3 <- anova(M2, update(M2, . ~ . + scale(Ancestry.3)))
av.2$Ances4 <- anova(M2, update(M2, . ~ . + scale(Ancestry.4)))
av.2$Ances5 <- anova(M2, update(M2, . ~ . + scale(Ancestry.5)))
av.2$Ances1.Gene <- anova(M2, update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(PMI) + scale(Ancestry.1) | Gene)))
av.2$Ances2.Gene <- anova(M2, update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(PMI) + scale(Ancestry.2) | Gene)))
av.2$Ances3.Gene <- anova(M2, update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(PMI) + scale(Ancestry.3) | Gene)))
av.2$Ances4.Gene <- anova(M2, update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(PMI) + scale(Ancestry.4) | Gene)))
av.2$Ances5.Gene <- anova(M2, update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(PMI) + scale(Ancestry.5) | Gene)))
```

```{r}
print.av(summarize.anova(av.2))
```

#### Notable results

* ancestry components are not equally important: only *Ancestry.1* and *Ancestry.3* appears to matter
* their main effect is weaker than their interaction with *Gene*
    * this is expected: the effect of *Age* should not depend on e.g. the *Institution*; so the result shows the advantage of joint modeling because previous results with separate, gene-based, modeling suggested strong interaction between *Age* and *Institution*

### Model $$M3$$ and $$M4$$

Based on the above findings the linear predictor for model $$M3$$ and $$M4$$ is defined as below, and $$M3$$ and $$M4$$ are fitted:

```{r cache=TRUE}
(M3 <- update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene)))
M4 <- update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(PMI) +
                           scale(Ancestry.1) + scale(Ancestry.3) | Gene) +
             scale(Ancestry.1))
```

While the fitting of the more simple model $$M3$$ converges that of the more complex $$M4$$ does not.  Therefore $$M3$$ will be used for subsequent analysis.

### Adding more biological terms

Now add *Gender* and *Dx* either as fixed effect, a random effect (both as main effect and as an interaction term with *Gene*)

```{r eval=TRUE, cache=TRUE, message=FALSE, warning=TRUE, echo=TRUE}
av.3 <- list()
# Gender
av.3$Gender.fix <- anova(M3, update(M3, . ~ . + Gender))
av.3$Gender.ran <- anova(M3, m <- update(M3, . ~ . + (1 | Gender)))
av.3$Gender.Gene <- anova(m, update(m, . ~ . + (1 | Gender:Gene)))
# Dx
av.3$Dx.fix <- anova(M3, update(M3, . ~ . + Dx))
av.3$Dx.ran <- anova(M3, m <- update(M3, . ~ . + (1 | Dx)))
av.3$Dx.Gene <- anova(m, update(m, . ~ . + (1 | Dx:Gene)))
```

Note that adding *Gender* and *Dx* in the following way is not the proper way because they are factors.  Moreover, the fit does not converge.

```{r eval=TRUE, cache=TRUE, message=FALSE, warning=TRUE, echo=TRUE}
# factor playing the role of slope doesn't make much sense
invisible(update(M1b, . ~ . + (Gender + scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene)))
```

#### Results

```{r}
print.av(summarize.anova(av.3))
```

Only *Gender*---but not *Dx*---improves the fit a little and only in interaction with *Gene*

### The impact of removing Age|Gene from M3

```{r cache=TRUE}
print.av(summarize.anova(list(anova(update(M1b, . ~ . + (scale(RIN) + scale(Ancestry.1) | Gene)),
              update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene))))))
```

### M5: 4 biol variables---convergence issues

M5 includes interaction of Ancestry.1, Age, Dx, Gender with Gene.  Therefore it is better suited to study the impact of any of these four variables by removing the variable:Gene term.

```{r cache=TRUE}
(M5 <- update(M1b, . ~ . + (1 | Gender:Gene) + (scale(Age) + scale(RIN) + scale(Ancestry.1) + scale(Ancestry.3) | Gene)))
(M5.Dx.Gene <- update(M5, . ~ . + (1 | Dx:Gene)))
```

The following sequence of ANOVA is removes each variable:Gene term.

```{r cache=TRUE, eval=FALSE}
av.5 <- list()
av.5$Age <-
    anova(update(M5, . ~ . + (Dx + Gender + scale(RIN) + scale(Ancestry.1) | Gene) - (Dx + Gender + scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene)),
          M5)
av.5$Ancestry.1 <-
    anova(update(M5, . ~ . + (Dx + Gender + scale(RIN) + scale(Age) | Gene) - (Dx + Gender + scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene)),
          M5)
av.5$Dx <-
    anova(update(M5, . ~ . + (Gender + scale(RIN) + scale(Age) + scale(Ancestry.1) | Gene) - (Dx + Gender + scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene)),
          M5)
av.5$Gender <-
    anova(update(M5, . ~ . + (Dx + scale(RIN) + scale(Age) + scale(Ancestry.1) | Gene) - (Dx + Gender + scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene)),
          M5)
```

M5 does not contain fixed effects

### M6

```{r cache=TRUE, eval=FALSE}
(M6 <- update(M1b, . ~ . + (scale(RIN) + scale(Ancestry.1) | Gene)))
```

```{r cache=TRUE, eval=FALSE}
av.6 <- list()
av.6$Age <- anova(M6, update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene)))
av.6$Ancestry.3 <- anova(M6, update(M1b, . ~ . + (scale(Ancestry.3) + scale(RIN) + scale(Ancestry.1) | Gene)))
av.6$Dx <- anova(M6, update(M1b, . ~ . + (Dx + scale(RIN) + scale(Ancestry.1) | Gene)))
av.6$Gender <- anova(M6, update(M1b, . ~ . + (Gender + scale(RIN) + scale(Ancestry.1) | Gene)))
av.6$PMI <- anova(M6, update(M1b, . ~ . + (scale(PMI) + scale(RIN) + scale(Ancestry.1) | Gene)))
```

```{r, eval=FALSE}
print.av(summarize.anova(av.6))
```

# Extending M3

```{r cache=TRUE, eval=FALSE}
M3.Gender <- update(M1b, . ~ . + (Gender + scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene))
M3.Dx <- update(M1b, . ~ . + (Dx + scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene))
M3.Ancestry.3 <- update(M1b, . ~ . + (scale(Ancestry.3) + scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene))
```

```{r eval=FALSE, cache=TRUE, message=FALSE, warning=TRUE, echo=TRUE}
av.3b <- list()
# Gender
av.3b$Gender <- anova(M3, M3.Gender)
av.3b$Dx <- anova(M3, M3.Dx)
av.3b$Ancestry.3 <- anova(M3, M3.Ancestry.3)
```

```{r, eval=FALSE}
print.av(summarize.anova(av.3b))
```

### M7

```{r cache=TRUE, eval=FALSE}
M7 <- M3.Ancestry.3
av.7 <- list()
# adding Dx terms
av.7$Dx.Gene <-
    anova(M7, update(M1b, . ~ . + (Dx + scale(Ancestry.3) + scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene)))
av.7$Dx.fix <- anova(M7, update(M7, . ~ . + Dx))
av.7$Dx.rnd <- anova(M7, update(M7, . ~ . + (1 | Dx)))
# omitting terms
av.7$Gene.0intercept <-
    anova(M7, update(M1b, . ~ . + (-1 + scale(Ancestry.3) + scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene)))
av.7$Age <- anova(M7, update(M1b, . ~ . + (scale(Ancestry.3) + scale(RIN) + scale(Ancestry.1) | Gene)))
av.7$Ancestry.1 <- anova(M7, update(M1b, . ~ . + (scale(Ancestry.3) + scale(Age) + scale(RIN) | Gene)))
av.7$Ancestry.3 <- anova(M7, update(M1b, . ~ . + (scale(Age) + scale(RIN) + scale(Ancestry.1) | Gene)))
```

```{r cache=TRUE, eval=FALSE}
av.7$Dx.Gene <- anova(M7, update(M7, . ~ . + (1 | Dx:Gene)))
av.7$Gender.Gene <- anova(M7, update(M7, . ~ . + (1 | Gender:Gene)))
av.7$Gender.fix <- anova(M7, update(M7, . ~ . + Gender))
av.7$Gender.rnd <- anova(M7, update(M7, . ~ . + (1 | Gender)))
```

```{r, eval=FALSE}
print.av(summarize.anova(av.7))
```

### Saving model formulas

Save all model formulas in the `results` directory

```{r, eval=FALSE}
write.csv(data.frame(lapply(list(M1 = M1, M1b = M1b, M2 = M2, M3 = M3, M4 = M4, M5 = M5),
                            function(x) as.character(formula(x)))),
          file = "../../results/M-formulas.csv", row.names = FALSE)
```

